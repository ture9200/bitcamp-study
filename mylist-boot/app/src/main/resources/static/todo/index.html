<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>To-do</title>
  <style>
  .todo-checked{
    text-decoration:line-through;
    color: gray;
  }
  </style>
</head>
  <body>
    <h1>To-do</h1>
    <a href="form.html">추가</a>
    <table id = "x-todo-table" border="1">
      <thead>
    <tr>
  <th></th>
  <th>해야할 일</th>
  <th>변경</th>
  <th>삭제</th>
  </tr>
</thead>
<tbody>
</tbody>
</table>

<input type = "text" id = "x-title-input">

<script type="text/javascript">
"use strict"

var titleInput = document.querySelector("#x-title-input");
//titleInput.style["display"] = "none";

var tbody = document.querySelector("#x-todo-table tbody")
//var buttons = document. querySelectorAll("button")
//console.log(buttons);

// 삭제버튼을 클릭했을 대 호출될 리스너 등록하기
// => 삭제 버튼은 동적으로 생성된다.
// => 따라서 부모태그에 리스너를 등록해야한다.
/*
tbody.onclick = function (e) {
  //console.log(e.target);
   //if (e.target.localName == "button") {
  if (e.target instanceof HTMLButtonElement) {
    console.log(e.target.getAttribute("data-no"));
    fetch(`/todo/delete?index=${no}`)
    .then(function(response) {
      return response.json();
    })
    .then(function(result) {
      if (result == 0) {
        window. alert ("삭제하지 못했습니다!");
      } else {
        location.reload();
      }
    });
  }
};
*/
  fetch("/todo/list") //서버와 연결하고 서버에 요청 후 서버로부터 응답받는다.
  .then(function(response) {  //then에 함수를 주면 서버로 부터 응답을 받으면 호출.
    return response.json();
    //서버에서 응답이 오면 이 함수를 호출 , response라는 변수에 넘김
    //응답이 왔고 원하는 포맷으로 왔다면 contacts 로 호출
    //이전에 받은 json 문자열을 parsing 해서 자바스크립트 객체배 로 바꾼 것을 리턴해달라고 함
  })
  .then(function(todoList) {  //이전 함수에 작업이 끝나면 호출
    //리턴한 객체를 contacts 가 받는다. 리턴받으면 아래 작업을 할것이다.
    console.log(todoList); //자바스크립트 객체배열을 출력

    for(var i = 0; i< todoList.length; i++) { //contacts는 문자열이 아니고 객체이기 때문에 더이상 콤마로 분류하는것이 아니다.
    //  var values=contact.split(",");  // 주어진 문자열을 콤마를 기준으로 쪼개라
      var tr= document.createElement("tr");
      // 태그를 만든다.
      var checkedOption = "";
      var titleTdOption = "";
      if (todoList[i].done){
        checkedOption = "checked";
        titleTdOption = "class='todo-checked'";
        //console.log("체크상자를 체크된 상태로 출력한다.");
      }
      tr.innerHTML = `<td><input type = "checkbox" ${checkedOption} onchange="checkTodo(${i}, event.target.checked)"></td>
      <td data-no = "${i}" ${titleTdOption}><span>${todoList[i]. title}</span> </td>
        <td><button type ="button" onclick = "updateTodo(${i})"> 변경 </td>
      <td><button type ="button" onclick = "deleteTodo(${i})"> 삭제 </td>`;
      /*
       no라고 하면 충돌이 될수 있기 때문에 없던 속성을 추가할때 data-no 로 쓰기를 권유하고 있다. 이건 규칙이다.
       <td><input type = "checkbox"></td>;
       */
      tbody.appendChild(tr); //tbody의 자식태그를 추가시킨다.
    }
  });

  function deleteTodo(no) {
  fetch(`/todo/delete?index=${no}`)
    .then(function(response) {
      return response.json();
    })
    .then(function(result) {
      if (result == 0) {
        window.alert("삭제하지 못했습니다!");
      } else {
        location.reload();
      }
    });
}

function checkTodo(no, checked) {
  console.log(no, checked);
  fetch (`/todo/check?index=${no}&done=${checked}`)
  .then (function(response) {
    return response.json();
})
  .then(function(result) {
    if(result == 0 ) {
      window.alert("변경하지 못했습니다!");
    } else {
  var titleTd = document.querySelector (`tbody td[data-no="${no}"]`);
  //console.log(titleTd.classList);

  if (checked) {
  titleTd.classList.add("todo-checked");
} else {
  titleTd.classList.remove("todo-checked");
      }
    }
  });
}

 function updateTodo(no) {
   // 현재 Todo 항목을 편집중인 상태에서 변경버튼을 눌렀다면
   if(titleInput.parentNode instanceof HTMLTableCellElement) {
     // 다른 항목을 편집하기 위해 이동하기 전에 편집 전의 상태로 되돌린다.
      titleInput.parentNode.querySelector("span").style["display"] = "";
   }

   var titleTd = document.querySelector (`tbody td[data-no="${no}"]`);
   var titleSpan = titleTd.querySelector("span");

   titleSpan.style["display"] = "none";

   // //Input 상자가 이미 todo 항목에 출력된 상태라면
   // // => 다른 todo 항목으로 이동하기 전에 현재 todo 항목을 원 상태로 만든다.
   // if (titleInput.parentNode instanceof HTMLTableCellElement) {
   //  titleInput.parentNode.innerHTML = titleInput.value;
   // }
  titleInput.value= titleSpan.innerHTML;
   //titleTd.innerHTML = "";
   titleTd.appendChild(titleInput);
 }

 titleInput.onkeyup = function(e) {
   var no = titleInput.parentNode.getAttribute("data-no");
   var originTitle = titleInput.parentNode.querySelector("span").innerHTML;
  if (e.keyCode == 13 && titleInput.value != "" && originTitle != titleInput.value) {
    fetch(`/todo/update?index=${no} & title=${titleInput.value}`)
      .then(function(response) {
        return response.json();
      })
      .then(function(result) {
        if (result == 0) {
          window.alert("변경하지 못했습니다!");
        } else {
          console.log("변경했습니다!");
          titleInput.parentNode.querySelector("span").innerHTML = titleInput.value;
          titleInput.parentNode.querySelector("span").style["display"] = "";
          titleInput.style["display"] = "none";
          document.body.appendChild(titleInput);
        }
      });
    }
 };

</script>
</body>
</html>
